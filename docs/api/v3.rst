API v3
======

The Read the Docs API uses :abbr:`REST (Representational State Transfer)`.
JSON is returned by all API responses including errors
and HTTP response status codes are to designate success and failure.

.. warning::

   APIv3 is currently under development and it's not ready to use yet.


Authentication and authorization
--------------------------------

Requests to the Read the Docs public API are for public and private information.
Some listing endpoints and some detailed ones are allowed to access without being authenticated.
Although, all endpoints that perform non-readonly operations, require authentication.


No authentication
~~~~~~~~~~~~~~~~~

Some endpoints on read-only requests won't require any kind of authentication.
Most of them are detailed information of specific listings for a particular object.


Token
~~~~~

The ``Authorization`` HTTP header can be specified with a ``Token`` to authenticate as a user
and have the same permissions that the user itself.


Session
~~~~~~~

Session authentication is allowed on very specific endpoints,
to allow hitting the API when reading documentation.

When a user is trying to authenticate via session, CSRF check is performed.


Resources
---------

Projects
~~~~~~~~

Projects list
+++++++++++++

.. http:get:: /api/v3/projects/

    Retrieve a list of all the projects for the current logged in user.

    **Example request**:

    .. sourcecode:: bash

        $ curl -H "Authorization: Token <token>" https://readthedocs.org/api/v3/projects/

    **Example response**:

    .. sourcecode:: json

        {
            "count": 25,
            "next": "/api/v3/projects/limit=10&offset=10",
            "previous": null,
            "results": ["PROJECT"]
        }

    :>json integer count: Total number of projects.
    :>json string next: URI for next set of projects.
    :>json string previous: URI for previous set of projects.
    :>json array results: Array of ``project`` objects.

    :query privacy_level: one of ``public``, ``private``, ``protected``

    .. TODO:

       Add query string filters to narrow the query:
         * privacy level
         * language
         * programming language
         * repository url
         * repository type
         * all fields?

       Considering that we are listing only projects associated with the authenticated user,
       we should not have performance problem with these filters

    :reqheader Authorization: required token to authenticate.


Project details
+++++++++++++++

.. http:get:: /api/v3/projects/(string:project_slug)/

    Retrieve details of a single project.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/

    **Example response**:

    .. sourcecode:: json

        {
            "name": "Pip",
            "slug": "pip",
            "description": "Pip Installs Packages.",
            "created": "2010-10-23T18:12:31+00:00",
            "modified": "2018-12-11T07:21:11+00:00",
            "language": {
                "code": "en",
                "name": "English"
            },
            "programming_language": {
                "code": "py",
                "name": "Python"
            },
            "repository": {
                "url": "https://github.com/pypa/pip",
                "type": "git"
            },
            "default_version": "stable",
            "default_branch": "master",
            "privacy_level": "public",
            "subproject_of": null,
            "translation_of": null,
            "urls": {
                "documentation": "http://pip.pypa.io/en/stable/",
                "project": "https://pip.pypa.io/"
            },
            "last_build": "{BUILD}",
            "tags": [
                "disutils",
                "easy_install",
                "egg",
                "setuptools",
                "virtualenv"
            ],
            "users": {
                "dstufft": "{USER}",
                "pmoore": "{USER}",
                "xafer": "{USER}",
                "pradyunsg": "{USER}"
            },
            "active_versions": {
                "stable": "{VERSION}",
                "latest": "{VERSION}",
                "19.0.2": "{VERSION}"
            },
            "links": {
                "self": "/api/v3/projects/pip/",
                "users": "/api/v3/projects/pip/users/",
                "versions": "/api/v3/projects/pip/versions/",
                "builds": "/api/v3/projects/pip/builds/",
                "subprojects": "/api/v3/projects/pip/subprojects/",
                "translations": "/api/v3/projects/pip/translations/"
            }
        }

    .. TODO: by default it should return *only active versions*, and
       having the possibility to return ``?only_active_versions=False`` or
       something like that. Otherwise, including all the versions by
       default will generate ton of data for some projects probably.


    :>json string name: The name of the project.
    :>json string slug: The project slug (used in the URL).
    :>json string description: An RST description of the project

    .. TODO: complete the returned data docs once agreed on this.

    :reqheader Authorization: optional token to authenticate.

    :statuscode 200: Success
    :statuscode 404: There is no ``Project`` with this slug



Versions
~~~~~~~~

Versions are different versions of the same project documentation.

The versions for a given project can be viewed in a project's version page.
For example, here is the `Pip project's version page`_.

.. _Pip project's version page: https://readthedocs.org/projects/pip/versions/


Versions listing
++++++++++++++++

.. http:get:: /api/v3/projects/(string:project_slug)/versions/

    Retrieve a list of all versions for a project.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/versions/

    **Example response**:

    .. sourcecode:: json

        {
            "count": 25,
            "next": "/api/v3/projects/pip/versions/?limit=10&offset=10",
            "previous": null,
            "results": ["VERSION"]
        }

    :>json integer count: Total number of Projects.
    :>json string next: URI for next set of Projects.
    :>json string previous: URI for previous set of Projects.
    :>json array results: Array of ``Version`` objects.

    .. TODO: instead of an array, this could potentially be a
       dictionary with the slug as the key and a VERSION as value.

    :query limit: limit number of object returned
    :query offset: offset from the whole list returned
    :query active: one of ``true``, ``false``
    :query built: one of ``true``, ``false``

    :reqheader Authorization: optional token to authenticate.


Version detail
++++++++++++++

.. http:get:: /api/v3/projects/(string:project_slug)/version/(string:version_slug)/

    Retrieve details of a single version.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/versions/latest/

    **Example response**:

    .. sourcecode:: json

        {
            "slug": "stable",
            "verbose_name": "stable",
            "identifier": "3a6b3995c141c0888af6591a59240ba5db7d9914",
            "built": true,
            "active": true,
            "type": "tag",
            "last_build": "{BUILD}",
            "downloads": {
                "pdf": "https://readthedocs.org/projects/pip/downloads/pdf/stable/",
                "htmlzip": "https://readthedocs.org/projects/pip/downloads/htmlzip/stable/",
                "epub": "https://readthedocs.org/projects/pip/downloads/epub/stable/"
            },
            "links": {
                "self": "/api/v3/projects/pip/versions/stable/",
                "builds": "/api/v3/projects/pip/versions/stable/builds/"
            }
        }

    :>json string slug: The slug for this version
    :>json string verbose_name: The name of the version
    :>json string identifier: A version control identifier for this version (eg. the commit hash of the tag)
    :>json string built: Whether this version has been built
    :>json string active: Whether this version is active
    :>json string type: The type of this version (typically "tag" or "branch")
    :>json string last_build: Build object representing the last build of this version
    :>json array downloads: URLs to downloads of this version's documentation

    :reqheader Authorization: optional token to authenticate.

    :statuscode 200: Success
    :statuscode 404: There is no ``Version`` with this slug for this project


Version edit
++++++++++++

.. http:patch:: /api/v3/projects/(string:project_slug)/version/(string:version_slug)/

    Edit a version.

    **Example request**:

    .. sourcecode:: json

        {
            "active": true,
            "privacy_level": "public",
            "tags": [
                "python",
                "packaging"
            ]
        }

    **Example response**:

    `See Version details <#version-detail>`_

    :reqheader Authorization: required token to authenticate.

    :statuscode 204: Edited sucessfully
    :statuscode 400: Some field is invalid
    :statuscode 401: Not valid permissions
    :statuscode 404: There is no ``Version`` with this slug for this project


Builds
~~~~~~

Builds are created by Read the Docs whenever a ``Project`` has its documentation built.
Frequently this happens automatically via a web hook but can be triggered manually.

Builds can be viewed in the build page for a project.
For example, here is `Pip's build page`_.

.. _Pip's build page: https://readthedocs.org/projects/pip/builds/


Build details
+++++++++++++

.. http:get:: /api/v3/projects/(str:project_slug)/builds/(int:build_id)/

    Retrieve details of a single build for a project.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/builds/8592686/

    **Example response**:

    .. sourcecode:: json

        {
            "id": 8592686,
            "version": "latest",
            "project": "pip",
            "created": "2018-06-19T15:15:59+00:00",
            "finished": "2018-06-19T15:16:58+00:00",
            "duration": 59,
            "state": {
                "code": "finished",
                "name": "Finished"
            },
            "success": true,
            "error": null,
            "commit": "6f808d743fd6f6907ad3e2e969c88a549e76db30",
            "builder": "build03",
            "cold_storage": false,
            "links": {
                "self": "/api/v3/projects/pip/builds/8592686/",
                "commands": "/api/v3/projects/pip/builds/8592686/commands/"
            }
        }


    :>json integer id: The ID of the build
    :>json string date: The ISO-8601 datetime of the build.
    :>json integer duration: The length of the build in seconds.
    :>json string state: The state of the build (one of "triggered", "building", "installing", "cloning", or "finished")
    :>json boolean success: Whether the build was successful
    :>json string error: An error message if the build was unsuccessful
    :>json string commit: A version control identifier for this build (eg. the commit hash)
    :>json string builder: The hostname server that built the docs
    :>json string cold_storage: Whether the build was removed from database and stored externally

    :reqheader Authorization: optional token to authenticate.

    :statuscode 200: Success
    :statuscode 404: There is no ``Build`` with this ID


.. http:get:: /api/v3/projects/(str:project_slug)/builds/latest/

    Retrieve details for latest build on this project.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/builds/latest/

    **Example response**:

    `See Build details <#build-details>`_

    :reqheader Authorization: optional token to authenticate.


Builds listing
++++++++++++++

.. http:get:: /api/v3/projects/(str:project_slug)/builds/

    Retrieve list of all the builds on this project.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/builds/

    **Example response**:

    .. sourcecode:: json

        {
            "count": 15,
            "next": "/api/v3/projects/pip/builds?limit=10&offset=10",
            "previous": null,
            "results": ["BUILD"]
        }

    :query commit: commit hash to filter the builds returned by commit
    :query running: whether or not to filter the builds returned by currently building

    :reqheader Authorization: optional token to authenticate.


Build triggering
++++++++++++++++


.. http:post:: /api/v3/projects/(string:project_slug)/builds/

    Trigger a new build for this project.

    **Example request**:

    .. sourcecode:: json

        {
            "version": "latest",
        }

    **Example response**:

    `See Build details <#build-details>`_

    :reqheader Authorization: required token to authenticate.

    :statuscode 201: Created sucessfully
    :statuscode 400: Some field is invalid
    :statuscode 401: Not valid permissions


Build commands listing
++++++++++++++++++++++

.. http:get:: /api/v3/projects/(str:project_slug)/builds/(int:build_id)/commands/

    Retrieve build command list of a single build.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/builds/719263915/commands/

    **Example response**:

    .. sourcecode:: json

        {
            "count": 15,
            "next": "/api/v3/projects/pip/builds/719263915/commands/?limit=10&offset=10",
            "previous": null,
            "results": ["BUILDCOMMAND"]
        }

    :reqheader Authorization: optional token to authenticate.


Build command details
+++++++++++++++++++++

.. http:get:: /api/v3/projects/(str:project_slug)/builds/(int:build_id)/commands/(int:buildcommand_id)

    Retrieve build command detail.

    **Example request**:

    .. sourcecode:: bash

        $ curl https://readthedocs.org/api/v3/projects/pip/builds/719263915/commands/9182639172/

    **Example response**:

    .. sourcecode:: json

        {
            "id": 9182639172,
            "build": "{BUILD}",
            "created": "2018-06-19T15:15:59+00:00",
            "finished": "2018-06-19T15:16:58+00:00",
            "duration": 59,
            "command": "cat docs/config.py",
            "output": "...",
            "exit_code": 0,
            "links": {
                "self": "/api/v3/projects/pip/builds/719263915/commands/9182639172/",
                "build": "/api/v3/projects/pip/builds/719263915/",
                "version": "/api/v3/projects/pip/versions/stable/",
                "project": "/api/v3/projects/pip/"
            }
        }

    :reqheader Authorization: optional token to authenticate.
